<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Ingredientes — Mermas, Planificador y Raciones Globales</title>
<style>
  :root{
    --ink:#4A2E1F; --ink-2:#5A3D2E; --accent:#8B5E3C; --line:#E2D8D1;
    --bg:#FFFFFF; --muted:#7C736D; --highlight:#F6EFEA;
    --rowShadow:0 2px 0 rgba(90,61,46,.06);
  }
  *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--ink);
    font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  header{background:#fff;border-bottom:1px solid var(--line)}
  .wrap{max-width:1200px;margin:auto;padding:16px 18px}
  h1{margin:0 0 6px;font-size:22px}
  nav a{color:var(--ink-2);text-decoration:none;font-weight:700;margin-right:6px}
  nav a.active{color:#2b1a11;text-decoration:underline}
  .toolbar{display:flex;flex-wrap:wrap;gap:10px;align-items:center;justify-content:space-between;margin:10px 0}
  input[type="text"],input[type="number"],input[type="search"]{
    border:1px solid var(--line);padding:8px 10px;border-radius:8px;font-size:14px;background:#fff;outline:none
  }
  button{border:1px solid var(--ink-2);background:var(--ink-2);color:#fff;
    padding:8px 12px;border-radius:8px;font-weight:600;cursor:pointer;font-size:13px}
  button.secondary{background:#fff;color:var(--ink-2)}
  button.ghost{background:#fff;border-color:var(--line);color:var(--ink)}
  table{width:100%;border-collapse:separate;border-spacing:0 12px}
  thead th{position:sticky;top:0;background:var(--bg);font-size:12px;color:var(--muted);padding:8px}
  tbody tr{background:#fff;border:1px solid var(--line);box-shadow:var(--rowShadow)}
  tbody td{padding:8px}
  .row{border-radius:12px;overflow:hidden}
  .num{width:120px} .readonly{background:#f9f7f5}
  .legend{font-size:12px;color:var(--muted);margin:6px 0}
  .cloud{font-size:12px;color:var(--muted);margin-left:10px}
  .sum{font-weight:700}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>Ingredientes — Mermas, Planificador y Raciones Globales</h1>
    <nav>
      <a class="tablink active" data-tab="tab1">1) Mermas</a> ·
      <a class="tablink" data-tab="tab2">2) Planificador</a> ·
      <a class="tablink" data-tab="tab3">3) Raciones globales</a>
    </nav>
    <div style="margin-top:8px">
      <label>Clave guardado:
        <input id="cloudKey" placeholder="ej. mugaritz-produccion" />
      </label>
      <span class="cloud" id="cloudStatus">—</span>
    </div>
  </div>
</header>

<!-- TAB 1 -->
<section class="wrap" id="tab1">
  <div class="toolbar">
    <div>
      <button id="addRow1" class="secondary">Añadir fila</button>
      <button id="clearAll1" class="ghost">Limpiar</button>
    </div>
  </div>
  <div class="legend">Cada cambio se guarda automáticamente (local + nube si hay clave).</div>
  <table>
    <thead><tr>
      <th>Ingrediente</th><th>Peso bruto (g)</th>
      <th>Merma 1 (g)</th><th>Merma 2 (g)</th><th>Merma 3 (g)</th>
      <th>Merma total</th><th>Rendimiento (g)</th><th>Rendimiento %</th><th></th>
    </tr></thead>
    <tbody id="tbody1"></tbody>
    <tfoot>
      <tr class="row">
        <td class="sum">Totales</td><td id="t1TotBruto" class="sum">0 g</td>
        <td id="t1TotM1" class="sum">0 g</td><td id="t1TotM2" class="sum">0 g</td>
        <td id="t1TotM3" class="sum">0 g</td><td id="t1TotMerma" class="sum">0 g</td>
        <td id="t1TotRend" class="sum">0 g</td><td id="t1TotPct" class="sum">0%</td><td></td>
      </tr>
    </tfoot>
  </table>
</section>

<!-- TAB 2 -->
<section class="wrap" id="tab2" style="display:none;">
  <div class="toolbar">
    <div>
      <button id="pfImport" class="secondary">Importar del Tab 1</button>
      <button id="pfAddRow" class="secondary">Añadir fila</button>
      <button id="pfClear" class="ghost">Limpiar</button>
    </div>
  </div>
  <div class="legend">Define rendimiento %, gramos por ración y raciones por ingrediente.</div>
  <table id="pfTable">
    <thead><tr>
      <th>Ingrediente</th><th>Rendimiento %</th><th>g por ración</th>
      <th>Raciones</th><th>Total ración</th><th>Bruto necesario</th><th></th>
    </tr></thead>
    <tbody></tbody>
    <tfoot>
      <tr class="row">
        <td class="sum">Totales</td>
        <td></td><td></td>
        <td id="pfTotRaciones" class="sum">0</td>
        <td id="pfTotTotalRacion" class="sum">0 g</td>
        <td id="pfTotBrutoNecesario" class="sum">0 g</td>
        <td></td>
      </tr>
    </tfoot>
  </table>
</section>

<!-- TAB 3 -->
<section class="wrap" id="tab3" style="display:none;">
  <div class="toolbar">
    <div>
      <label>Raciones: <input id="qpRaciones" type="number" min="0" step="1" style="width:120px" /></label>
      <label style="margin-left:10px">g/ración (global):
        <input id="qpGRacion" type="number" min="0" step="any" style="width:140px" />
      </label>
    </div>
  </div>
  <div class="legend">Usa el % de rendimiento del Tab 1 y un g/ración global.</div>
  <table id="qpTable">
    <thead><tr>
      <th>Ingrediente</th><th>Rendimiento %</th><th>g/ración (global)</th>
      <th>Raciones</th><th>Bruto necesario</th>
    </tr></thead>
    <tbody></tbody>
  </table>
</section>

<script>
/* =================== UTILIDADES =================== */
const STORAGE1='calc_tab1_v1', STORAGE2='calc_tab2_v1', STORAGE3='calc_tab3_v1', SYNC_KEY='cloud_key';
const $=s=>document.querySelector(s), $$=s=>Array.from(document.querySelectorAll(s));
const SAFE_ARR = x => Array.isArray(x) ? x : [];
const parseNum=x=>parseFloat(String(x).replace(',','.'))||0;
const fmtPct=v=> (Number(v)||0).toFixed(2).replace(/\.00$/,'')+'%';
function fmtW(g){const v=Number(g)||0; if(v>=1000){return (v/1000).toFixed(3).replace(/0+$/,'').replace(/\.$/,'')+' kg';} return String((+v.toFixed(10))).replace(/\.0+$/,'')+' g';}
function slugify(s){return String(s).normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase().trim().replace(/[^a-z0-9-_]+/g,'-').replace(/--+/g,'-');}
function debounce(fn,ms){let t; return (...a)=>{clearTimeout(t); t=setTimeout(()=>fn(...a),ms);}}

/* =================== TABS =================== */
$$('.tablink').forEach(a=>a.onclick=(e)=>{
  e.preventDefault();
  const id=a.dataset.tab;
  ['tab1','tab2','tab3'].forEach(t=>$('#'+t).style.display=(t===id?'block':'none'));
  $$('.tablink').forEach(x=>x.classList.toggle('active', x===a));
  if(id==='tab3') qpBuild();
});

/* =================== TAB 1: MERMAS =================== */
function addRow1(d={}){
  const tr=document.createElement('tr'); tr.className='row';
  tr.innerHTML = `
    <td><input class="name" placeholder="Ingrediente" value="${d.name||''}"></td>
    <td><input type="number" step="any" class="bruto" placeholder="0" value="${d.bruto||''}"></td>
    <td><input type="number" step="any" class="m1" placeholder="0" value="${d.m1||''}"></td>
    <td><input type="number" step="any" class="m2" placeholder="0" value="${d.m2||''}"></td>
    <td><input type="number" step="any" class="m3" placeholder="0" value="${d.m3||''}"></td>
    <td><input readonly class="mt readonly"></td>
    <td><input readonly class="rend readonly"></td>
    <td><input readonly class="pct readonly"></td>
    <td><button class="ghost del">Eliminar</button></td>`;
  tr.querySelector('.del').onclick=()=>{tr.remove(); recalc1(); save1();};
  tr.querySelectorAll('input').forEach(inp=>{
    if(!inp.classList.contains('readonly')){
      inp.addEventListener('input', ()=>{ recalc1(); save1(); });
    }
  });
  $('#tbody1').appendChild(tr);
}
function recalc1(){
  let tB=0,tM1=0,tM2=0,tM3=0,tMt=0,tR=0;
  $$('#tbody1 tr').forEach(tr=>{
    const b=parseNum(tr.querySelector('.bruto').value),
          m1=parseNum(tr.querySelector('.m1').value),
          m2=parseNum(tr.querySelector('.m2').value),
          m3=parseNum(tr.querySelector('.m3').value);
    const mt=m1+m2+m3; const r=Math.max(b-mt,0); const pct=b?(r/b*100):0;
    tr.querySelector('.mt').value = fmtW(mt);
    tr.querySelector('.rend').value = fmtW(r);
    tr.querySelector('.pct').value = fmtPct(pct);
    tB+=b; tM1+=m1; tM2+=m2; tM3+=m3; tMt+=mt; tR+=r;
  });
  $('#t1TotBruto').textContent=fmtW(tB);
  $('#t1TotM1').textContent=fmtW(tM1);
  $('#t1TotM2').textContent=fmtW(tM2);
  $('#t1TotM3').textContent=fmtW(tM3);
  $('#t1TotMerma').textContent=fmtW(tMt);
  $('#t1TotRend').textContent=fmtW(tR);
  $('#t1TotPct').textContent=fmtPct(tB? (tR/tB*100):0);
}
function save1(){
  const rows=$$('#tbody1 tr').map(tr=>({
    name: tr.querySelector('.name').value||'',
    bruto: tr.querySelector('.bruto').value||'',
    m1: tr.querySelector('.m1').value||'',
    m2: tr.querySelector('.m2').value||'',
    m3: tr.querySelector('.m3').value||'',
  }));
  localStorage.setItem(STORAGE1, JSON.stringify({rows}));
  scheduleSync();
}
function restore1(){
  const raw=localStorage.getItem(STORAGE1);
  if(!raw){ for(let i=0;i<5;i++) addRow1(); recalc1(); return; }
  try{
    const data=JSON.parse(raw);
    const rows=SAFE_ARR(data.rows);
    (rows.length?rows:Array.from({length:5})).forEach(r=> addRow1(r||{}));
    recalc1();
  }catch{ for(let i=0;i<5;i++) addRow1(); recalc1(); }
}
$('#addRow1').onclick=()=>{ addRow1(); save1(); };
$('#clearAll1').onclick=()=>{ if(confirm('¿Limpiar Tab 1?')){ localStorage.removeItem(STORAGE1); $('#tbody1').innerHTML=''; for(let i=0;i<5;i++) addRow1(); recalc1(); scheduleSync(); } };

/* =================== TAB 2: PLANIFICADOR =================== */
function elTxt(cls,val){const i=document.createElement('input'); i.type='text'; i.className=cls; i.value=val||''; i.placeholder='Ingrediente'; return i;}
function elNum(cls,val){const i=document.createElement('input'); i.type='number'; i.step='any'; i.className=cls; i.value=val||''; i.placeholder='0'; return i;}
function elRO(cls){const i=document.createElement('input'); i.readOnly=true; i.className='readonly '+cls; return i;}

function addRowPF(d={}){
  const tr=document.createElement('tr'); tr.className='row';
  const tdN=document.createElement('td'); const n=elTxt('pfName', d.name); tdN.appendChild(n);
  const tdP=document.createElement('td'); const p=elNum('pfPct', d.pct);
  const tdG=document.createElement('td'); const g=elNum('pfG', d.g);
  const tdR=document.createElement('td'); const r=elNum('pfR', d.r);
  const tdTR=document.createElement('td'); const trTot=elRO('pfTotalR');
  const tdB=document.createElement('td'); const b=elRO('pfBruto');
  const tdA=document.createElement('td'); const del=document.createElement('button'); del.className='ghost'; del.textContent='Eliminar';
  del.onclick=()=>{ tr.remove(); recalcPF(); savePF(); };
  tdA.appendChild(del);
  tr.append(tdN, tdP, tdG, tdR, tdTR, tdB, tdA);
  [n,p,g,r].forEach(inp=> inp.addEventListener('input', ()=>{ recalcPF(); savePF(); }));
  $('#pfTable tbody').appendChild(tr);
}
function recalcPF(){
  let totR=0, totTR=0, totB=0;
  $$('#pfTable tbody tr').forEach(tr=>{
    const pct = Math.max(0,Math.min(100,parseNum(tr.querySelector('.pfPct').value)));
    const g   = Math.max(0,parseNum(tr.querySelector('.pfG').value));
    const r   = Math.max(0,parseNum(tr.querySelector('.pfR').value));
    const totalR=g*r;
    const bruto=pct>0 ? totalR/(pct/100):0;
    tr.querySelector('.pfTotalR').value=fmtW(totalR);
    tr.querySelector('.pfBruto').value=fmtW(bruto);
    totR+=r; totTR+=totalR; totB+=bruto;
  });
  $('#pfTotRaciones').textContent=String(totR);
  $('#pfTotTotalRacion').textContent=fmtW(totTR);
  $('#pfTotBrutoNecesario').textContent=fmtW(totB);
}
function savePF(){
  const rows=$$('#pfTable tbody tr').map(tr=>({
    name: tr.querySelector('.pfName').value||'',
    pct: tr.querySelector('.pfPct').value||'',
    g: tr.querySelector('.pfG').value||'',
    r: tr.querySelector('.pfR').value||'',
  }));
  localStorage.setItem(STORAGE2, JSON.stringify({rows}));
  scheduleSync();
}
function restorePF(){
  const raw=localStorage.getItem(STORAGE2); if(!raw) return;
  try{ const data=JSON.parse(raw); SAFE_ARR(data.rows).forEach(addRowPF); recalcPF(); }catch{}
}
$('#pfAddRow').onclick=()=>{ addRowPF(); savePF(); };
$('#pfClear').onclick=()=>{ if(confirm('¿Limpiar Tab 2?')){ localStorage.removeItem(STORAGE2); $('#pfTable tbody').innerHTML=''; recalcPF(); scheduleSync(); } };
$('#pfImport').onclick=()=>{
  const existing=new Set($$('#pfTable tbody .pfName').map(i=>i.value.trim().toLowerCase()));
  $$('#tbody1 tr').forEach(tr=>{
    const n=(tr.querySelector('.name').value||'').trim(); if(!n) return;
    const pctStr=(tr.querySelector('.pct').value||'0').replace('%','').trim();
    const pct=Math.max(0,Math.min(100,parseNum(pctStr)));
    if(!existing.has(n.toLowerCase())){ addRowPF({name:n,pct}); existing.add(n.toLowerCase()); }
  });
  recalcPF(); savePF();
};

/* =================== TAB 3: RACIONES GLOBALES =================== */
const qpR = $('#qpRaciones'), qpG = $('#qpGRacion');
function qpBuild(){
  const tbody=$('#qpTable tbody'); tbody.innerHTML='';
  const r= Math.max(0, parseNum(qpR.value||0));
  const g= Math.max(0, parseNum(qpG.value||0));
  $$('#tbody1 tr').forEach(tr=>{
    const name=(tr.querySelector('.name').value||'').trim(); if(!name) return;
    const pctStr=(tr.querySelector('.pct').value||'0').replace('%','').trim();
    const pct=Math.max(0,Math.min(100,parseNum(pctStr)));
    const bruto = pct>0 ? (g*r)/(pct/100) : 0;
    const row=document.createElement('tr'); row.className='row';
    row.innerHTML = `<td>${name}</td><td>${pct.toFixed(2)}%</td><td>${g}</td><td>${r}</td><td>${fmtW(bruto)}</td>`;
    tbody.appendChild(row);
  });
}
function saveQP(){
  localStorage.setItem(STORAGE3, JSON.stringify({ r: qpR.value||'0', g: qpG.value||'0' }));
  scheduleSync();
}
function restoreQP(){
  const raw=localStorage.getItem(STORAGE3); if(!raw) return;
  try{ const d=JSON.parse(raw); if(d.r!=null) qpR.value=d.r; if(d.g!=null) qpG.value=d.g; }catch{}
  qpBuild();
}
qpR.addEventListener('input', ()=>{ qpBuild(); saveQP(); });
qpG.addEventListener('input', ()=>{ qpBuild(); saveQP(); });

/* =================== CLOUD SYNC =================== */
const cloudKeyInput=$('#cloudKey'), cloudStatus=$('#cloudStatus');
function currentKey(){ return localStorage.getItem(SYNC_KEY)||''; }
cloudKeyInput.addEventListener('change', ()=>{
  const k=slugify(cloudKeyInput.value); cloudKeyInput.value=k;
  if(k){ localStorage.setItem(SYNC_KEY,k); cloudLoadInitial(k); }
  else { localStorage.removeItem(SYNC_KEY); cloudStatus.textContent='—'; }
});

// Empaquetar todo el estado (3 tabs)
function collectState(){
  let tab1={rows:[]};
  try{ tab1 = JSON.parse(localStorage.getItem(STORAGE1)||'{"rows":[]}'); }catch{}
  let tab2={rows:[]};
  try{ tab2 = JSON.parse(localStorage.getItem(STORAGE2)||'{"rows":[]}'); }catch{}
  let tab3={};
  try{ tab3 = JSON.parse(localStorage.getItem(STORAGE3)||'{}'); }catch{}
  return { tab1, tab2, tab3 };
}

const syncNow = async () => {
  const key=currentKey(); if(!key) return;
  try{
    cloudStatus.textContent='🔄 guardando…';
    const data=collectState();
    const res = await fetch('/.netlify/functions/state-save',{
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ key, data })
    });
    if(!res.ok) throw new Error('save failed '+res.status);
    cloudStatus.textContent='✅ guardado';
  }catch(e){
    cloudStatus.textContent='⚠️ error';
    console.error('Cloud save error:', e);
  }
};
const scheduleSync = debounce(syncNow, 600);

async function cloudLoadInitial(k){
  try{
    cloudStatus.textContent='🔎 cargando…';
    const res = await fetch('/.netlify/functions/state-get?key='+encodeURIComponent(k));
    if(res.ok){
      const j=await res.json();
      if(j.data?.tab1){ localStorage.setItem(STORAGE1, JSON.stringify(j.data.tab1)); }
      if(j.data?.tab2){ localStorage.setItem(STORAGE2, JSON.stringify(j.data.tab2)); }
      if(j.data?.tab3){ localStorage.setItem(STORAGE3, JSON.stringify(j.data.tab3)); }
      // Re-render
      $('#tbody1').innerHTML=''; restore1(); recalc1();
      $('#pfTable tbody').innerHTML=''; restorePF(); recalcPF();
      restoreQP(); // ya construye
      cloudStatus.textContent='☁️ cargado';
    }else if(res.status===404){
      cloudStatus.textContent='(sin datos en nube)';
    }else{
      cloudStatus.textContent='⚠️ error';
    }
  }catch(e){
    cloudStatus.textContent='⚠️ error';
    console.error('Cloud load error:', e);
  }
}

// backup al cerrar
window.addEventListener('beforeunload', ()=>{
  const key=currentKey();
  if(key && navigator.sendBeacon){
    const payload = JSON.stringify({ key, data: collectState() });
    navigator.sendBeacon('/.netlify/functions/state-save', payload);
  }
});

/* =================== INIT =================== */
(function init(){
  // Restaurar locales
  restore1(); recalc1();
  restorePF(); recalcPF();
  restoreQP();

  // Leer ?key= o clave guardada
  const urlKey = (new URL(location.href)).searchParams.get('key') || '';
  const keyToUse = slugify(urlKey || currentKey());
  if(keyToUse){
    cloudKeyInput.value=keyToUse;
    localStorage.setItem(SYNC_KEY,keyToUse);
    cloudLoadInitial(keyToUse);
  }
})();
</script>
</body>
</html>
