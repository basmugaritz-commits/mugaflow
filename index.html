<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Control rendimientos y pedidos - suite 3</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="theme-color" content="#000000" />
  <link rel="manifest" href="manifest.json" />
  <style>
    body{font-family:system-ui,Arial,sans-serif;margin:0;padding:0 12px 60px}
    header{position:sticky;top:0;background:#fff;border-bottom:1px solid #eee;padding:12px 10px;z-index:10}
    .status-badge{position:fixed;right:10px;bottom:10px;background:#222;color:#fff;padding:6px 10px;
      border-radius:8px;font:12px/1.2 system-ui;opacity:.95;z-index:99999}
  </style>
</head>
<body>
  <header>
    <h1>Control rendimientos y pedidos — suite 3</h1>
  </header>

  <!-- 🔽🔽🔽 AQUÍ VA EL RESTO DE TU APP (tabs, tablas, etc.) 🔽🔽🔽 -->
  <!-- Pega tu contenido original aquí, yo no lo modifiqué -->
  <!-- 🔼🔼🔼 FIN APP 🔼🔼🔼 -->

  <!-- === INICIO: Sincronización con Neon vía Netlify Functions === -->
  <script>
  (() => {
    const SAVE_URL = '/.netlify/functions/state-save';
    const GET_URL  = '/.netlify/functions/state-get?key=calc_suite3';

    // Badge de estado
    const badge = document.createElement('div');
    badge.id = 'sync-badge';
    badge.className = 'status-badge';
    badge.textContent = 'Listo';
    window.addEventListener('load', () => document.body.appendChild(badge));
    const setBadge = (t)=>{ const el=document.getElementById('sync-badge'); if(el) el.textContent=t; };

    // Intenta detectar las claves usadas por tu app
    const STORAGE1 = (window.STORAGE1 || 'ingredientes_data');
    const STORAGE2 = (window.STORAGE2 || 'planificador_data');

    async function remoteSave(key, data){
      try{
        setBadge('Guardando…');
        await fetch(SAVE_URL, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ key, data })
        });
        setBadge('Guardado ✓');
      }catch(e){
        console.error('remoteSave error', e);
        setBadge('Error al guardar');
      }
    }
    async function remoteLoad(key){
      try{
        setBadge('Cargando…');
        const r = await fetch(GET_URL, { cache: 'no-store' });
        const j = await r.json().catch(()=> ({}));
        setBadge('Listo');
        return j && j.data ? j.data : null;
      }catch(e){
        console.error('remoteLoad error', e);
        setBadge('Error al cargar');
        return null;
      }
    }

    // Guardar todo el estado de tabs 1 y 2
    function syncSave(){
      try{
        const data = {
          tab1: JSON.parse(localStorage.getItem(STORAGE1) || '{}'),
          tab2: JSON.parse(localStorage.getItem(STORAGE2) || '{}')
        };
        remoteSave('calc_suite3', data);
      }catch(e){ console.error('syncSave error', e); }
    }

    // Engancha save1 y savePF
    const _save1 = window.save1;
    if (typeof _save1 === 'function') {
      window.save1 = function(){ const r = _save1.apply(this, arguments); syncSave(); return r; };
    }
    const _savePF = window.savePF;
    if (typeof _savePF === 'function') {
      window.savePF = function(){ const r = _savePF.apply(this, arguments); syncSave(); return r; };
    }

    // Carga inicial desde Neon y repuebla tablas
    window.addEventListener('DOMContentLoaded', async () => {
      const data = await remoteLoad('calc_suite3');
      if (data) {
        if (data.tab1) localStorage.setItem(STORAGE1, JSON.stringify(data.tab1));
        if (data.tab2) localStorage.setItem(STORAGE2, JSON.stringify(data.tab2));
        if (typeof window.restore1 === 'function') {
          const t1 = document.getElementById('tbody1'); if (t1) t1.innerHTML = '';
          window.restore1();
        }
        if (typeof window.restorePF === 'function') {
          const tb = document.querySelector('#pfTable tbody'); if (tb) tb.innerHTML='';
          window.restorePF();
        }
      }
    });

    // Backup: guardado por cambios globales
    let timer;
    function schedule(){ clearTimeout(timer); timer = setTimeout(syncSave, 800); }
    document.addEventListener('input', schedule, true);
    document.addEventListener('change', schedule, true);
  })();
  </script>
  <!-- === FIN: Sincronización con Neon vía Netlify Functions === -->

</body>
</html>
