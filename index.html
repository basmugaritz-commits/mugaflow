<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Control rendimientos y pedidos - suite 3</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="theme-color" content="#000000" />
  <!-- (Opcional) si ya tienes manifest y sw, d√©jalo igual -->
  <link rel="manifest" href="manifest.json" />
  <style>
    /* Estilos m√≠nimos; tu app puede traer los suyos */
    body{font-family:system-ui,Arial,sans-serif;margin:0;padding:0 12px 60px}
    header{position:sticky;top:0;background:#fff;border-bottom:1px solid #eee;padding:12px 10px;z-index:10}
    .status-badge{position:fixed;right:10px;bottom:10px;background:#222;color:#fff;padding:6px 10px;
      border-radius:8px;font:12px/1.2 system-ui;opacity:.95;z-index:99999}
    .help{font-size:12px;color:#666}
    .container{max-width:1100px;margin:0 auto}
    .demo{display:grid;gap:8px;border:1px dashed #ddd;border-radius:8px;padding:10px;margin:12px 0}
    .demo input,.demo textarea,.demo select{padding:8px;font-size:14px}
  </style>
</head>
<body>
  <header class="container">
    <h1>Control rendimientos y pedidos ‚Äî suite 3</h1>
    <div class="help">Auto-guardado activado ¬∑ Los campos se guardan en tu base de datos Neon a trav√©s de Netlify Functions.</div>
  </header>

  <main class="container">
    <!-- üîΩüîΩüîΩ  AQU√ç VA TU APP EXISTENTE  üîΩüîΩüîΩ -->
    <!-- Si quieres, elimina el bloque ‚Äúdemo‚Äù de ejemplo de abajo -->
    <section class="demo">
      <strong>Bloque de ejemplo (puedes borrarlo):</strong>
      <input id="ingrediente" name="ingrediente" placeholder="Ingrediente" />
      <input id="peso_bruto" name="peso_bruto" type="number" placeholder="Peso bruto (g)" />
      <textarea id="notas" name="notas" placeholder="Notas‚Ä¶"></textarea>
      <select id="turno" name="turno">
        <option value="">Selecciona turno‚Ä¶</option>
        <option>Ma√±ana</option>
        <option>Tarde</option>
      </select>
    </section>
    <!-- üîºüîºüîº  FIN ZONA PARA TU APP  üîºüîºüîº -->
  </main>

  <div id="autosave-badge" class="status-badge" role="status" aria-live="polite">Listo</div>

  <script>
  /* ====== Auto-save global a Neon mediante Netlify Functions ======
     - Guarda autom√°ticamente cualquier <input>, <textarea> o <select>
     - Restaura al cargar
     - Cambia la KEY si quieres ‚Äúperfiles‚Äù distintos (por ejemplo por usuario/turno)
  */
  const KEY = 'app_global_v1'; // <‚Äî c√°mbiala si quieres perfiles separados
  const SAVE_URL = '/.netlify/functions/state-save';
  const GET_URL  = '/.netlify/functions/state-get?key=' + encodeURIComponent(KEY);

  const badge = document.getElementById('autosave-badge');
  const setBadge = (txt) => { badge.textContent = txt; };

  // Serializa todos los campos editables del documento
  function serializeFormState() {
    const data = {};
    document.querySelectorAll('input, textarea, select').forEach(el => {
      // Ignora campos sin id ni name para no guardar "ruido"
      const k = el.name || el.id;
      if (!k) return;

      if (el.type === 'checkbox') data[k] = el.checked;
      else if (el.type === 'radio') { if (el.checked) data[k] = el.value; }
      else data[k] = el.value;
    });
    return data;
  }

  // Aplica un estado a los campos
  function applyFormState(data) {
    if (!data || typeof data !== 'object') return;
    for (const [k, v] of Object.entries(data)) {
      // Selecciona por name o id
      let el = document.querySelector(`[name="${CSS.escape(k)}"]`) || document.getElementById(k);
      if (!el) continue;

      if (el.type === 'checkbox') el.checked = !!v;
      else if (el.type === 'radio') {
        const r = document.querySelector(`input[type="radio"][name="${CSS.escape(k)}"][value="${CSS.escape(v)}"]`);
        if (r) r.checked = true;
      } else {
        el.value = v;
      }
      // Dispara evento por si tu app calcula cosas al escribir
      el.dispatchEvent(new Event('input', { bubbles: true }));
      el.dispatchEvent(new Event('change', { bubbles: true }));
    }
  }

  // Carga inicial
  async function loadState() {
    try {
      setBadge('Cargando‚Ä¶');
      const res = await fetch(GET_URL, { cache: 'no-store' });
      const json = await res.json().catch(() => ({}));
      if (json && json.data) applyFormState(json.data);
      setBadge('Listo');
    } catch (err) {
      console.error('Error al cargar estado:', err);
      setBadge('Error al cargar');
    }
  }

  // Guardado con debounce para no saturar
  let timer;
  function scheduleSave() { clearTimeout(timer); timer = setTimeout(saveState, 700); }

  async function saveState() {
    try {
      setBadge('Guardando‚Ä¶');
      const body = { key: KEY, data: serializeFormState() };
      await fetch(SAVE_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body)
      });
      setBadge('Guardado ‚úì');
    } catch (err) {
      console.error('Error al guardar estado:', err);
      setBadge('Error al guardar');
    }
  }

  // Escucha cambios en toda la p√°gina
  document.addEventListener('input', scheduleSave, true);
  document.addEventListener('change', scheduleSave, true);

  // Arranque
  loadState();
  </script>

  <script>
  // (Opcional) registra el Service Worker si ya tienes sw.js
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('/sw.js').catch(()=>{});
  }
  </script>
</body>
</html>
